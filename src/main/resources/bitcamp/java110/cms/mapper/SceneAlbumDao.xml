<?xml version="1.0" encoding="UTF-8"?>
<!-- SceneAlbumDao 클래스가 사용할 SQL이 들어 있는 파일 -->
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bitcamp.java110.cms.dao.SceneAlbumDao">

    <resultMap type="sceneAlbum" id="sceneAlbumMap">
        <id column="lbmno" property="lbmno" />
        <result column="mno" property="mno" />
        <result column="lbm_nm" property="lbmTitle" />
        <result column="phot" property="phot" />
        <result column="cdt" property="cdt" />
        <result column="mdt" property="mdt" />
        <result column="opn" property="open" />
        <result column="include" property="include" />
        <result column="srCnt" property="srCnt" />
    </resultMap>

    <insert id="insert" parameterType="map" 
        useGeneratedKeys="true" keyColumn="lbmno" keyProperty="lbmno">
        insert into mv_lbm( mno, lbm_nm, cdt,opn)
        values(#{mno}, #{sceneAlbum.lbmTitle},
        now(),if(#{sceneAlbum.open},'u','l'))
        <!-- #{mno}, true면 unlock, false면 lock -->
    </insert>

    <select id="srAlbumList" resultMap="sceneAlbumMap" parameterType="map">
        select
            l.mno,
            l.opn,
            l.lbm_nm,
            l.lbmno,
            s.srno
        from
            mv_lbm_sr s, mv_lbm l
        where
            s.lbmno = l.lbmno and l.mno=#{mno} and l.lbmno=#{sceneAlbum.lbmno}   
    </select>
    
    <select id="findByNo" resultMap="sceneAlbumMap" parameterType="int">
    </select>
    
    <select id="findAll" resultMap="sceneAlbumMap" parameterType="int">
        select
            l.lbmno,
            l.mno,
            l.lbm_nm,
            l.phot,
            l.cdt,
            l.mdt,
            (l.opn ='u') opn
        from mv_lbm l
            inner join mv_memb m on m.mno = l.mno
            where l.mno = #{mno}
        order by
            cdt desc
    </select>
    
    <select id="findAll2" resultMap="sceneAlbumMap" parameterType="map">
        select lbm.lbmno,
               lbm.lbm_nm,
               (sr.srno is not null) as include
          from mv_lbm lbm 
                left join (
                    select lbmno, srno
                    from mv_lbm_sr
                    where srno=#{srno}) sr
            on lbm.lbmno = sr.lbmno
         where lbm.mno=#{mno}
         order by cdt desc;
    </select>
    
    <select id="findByPageNo" resultMap="sceneAlbumMap" parameterType="map">
        select
            l.lbmno,
            l.mno,
            l.lbm_nm,
            l.phot,
            l.cdt,
            l.mdt,
            (l.opn ='u') opn,
            sr.cnt as srCnt  
        from 
            mv_lbm l
            inner join mv_memb m on m.mno = l.mno
            left join (SELECT
                            l.lbmno, count(s.srno) as cnt
                        from
                            mv_lbm l, mv_lbm_sr s
                        where
                            l.lbmno = s.lbmno 
                        group by lbmno) as sr on l.lbmno = sr.lbmno
        where l.mno = #{mno}
        order by
            cdt desc
        limit #{paging.startRowNo} , #{paging.pageSize}
        
    </select>
    
    <select id="getTotalCnt" resultType="int" parameterType="int">
        select
            count(l.lbmno)
        from mv_lbm l
            inner join mv_memb m on m.mno = l.mno
            where l.mno = #{mno}
    </select>

    <delete id="delete" parameterType="int">
    </delete>
    
    <update id="signOut1" parameterType="int">
        UPDATE IGNORE
            mv_lbm
        SET
            mno=21
        WHERE
             opn='U'
        AND mno=#{mno}
    </update>
    
    <delete id="signOut2" parameterType="int">
        DELETE IGNORE
        FROM
            mv_lbm_sr
        WHERE
            (SELECT lbmno
             FROM
                mv_lbm
             WHERE
                 opn='L'
                 AND mno=#{mno} )
    </delete>
    
    <delete id="signOut3" parameterType="int">
        DELETE IGNORE
        FROM
            mv_lbm
        WHERE
             opn='L'
        AND mno=#{mno}
    </delete>

</mapper>