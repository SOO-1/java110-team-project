<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bitcamp.java110.cms.dao.SceneReviewDao">

    <resultMap type="sceneReview" id="srMap">
        <id     column="srno"      property="srno"/>
        <result column="mvno"      property="mvno" />
        <result column="mno"       property="mno" />
        <result column="titl"      property="title" />
        <result column="time"      property="time" />
        <result column="phot"      property="photo" />
        <result column="cont"      property="cont" />
        <result column="spo"       property="spo" />
    </resultMap>
    
    <resultMap type="sceneReviewCmt" id="srCmtMap">
        <id     column="cmno"      property="cmno"/>
        <result column="srno"      property="srno"/>
        <result column="mno"       property="mno"/>
        <result column="phot"      property="photo"/>
        <result column="cont"      property="cont"/>
        <result column="cdt"       property="createdDate"/>
        <result column="mdt"       property="modifiedDate"/>
        <association property="map" javaType="sceneReviewMap">
            <id     column="mpno"  property="mpno"/>
            <result column="cmno"  property="cmno"/>
            <result column="mp_nm" property="mapName"/>
            <result column="lat"   property="lat"/>
            <result column="lng"   property="lng"/>
        </association>
        <association property="member" javaType="member">
            <id     column="mno"    property="mno"/>
            <result column="nick"   property="nickname"/>
            <result column="p_phot" property="profileImage"/>
        </association>
    </resultMap>

    <insert id="insert" parameterType="sceneReview"
            useGeneratedKeys="true" keyColumn="srno" keyProperty="srno">
        INSERT INTO mv_sr(mvno, mno, titl, time, phot, cont, spo, cdt)
        VALUES(#{mvno}, #{mno}, #{title}, #{time}, #{photo}, #{cont}, #{spo}, now())
    </insert>
    
    <insert id="insertCmt" parameterType="sceneReviewCmt"
            useGeneratedKeys="true" keyColumn="cmno" keyProperty="cmno">
        INSERT INTO mv_sr_cmt(srno, mno, phot, cont, cdt)
        VALUES (#{srno}, #{mno}, #{photo}, #{cont}, now())
    </insert>
    
    <insert id="insertCmtMap" parameterType="sceneReviewMap">
        INSERT INTO mv_sr_map(cmno, mp_nm, lat, lng)
        VALUES (#{cmno}, #{mapName}, #{lat}, #{lng})
    </insert>
    
    <select id="findDefaultTime" resultType="string" parameterType="int">
        SELECT time
          FROM mv_sr
         WHERE mvno = #{value}
         ORDER BY time ASC
         LIMIT 1
    </select>
    
    <select id="findByTime" resultMap="srMap" parameterType="map">
        SELECT srno, mvno, mno, titl, time, phot, cont, spo
          FROM mv_sr
         WHERE mvno = #{mvno}
           AND time = #{time}
    </select>
    
    <select id="findByNo" resultMap="srMap" parameterType="int">
        SELECT srno, mvno, mno, titl, time, phot, cont, spo
          FROM mv_sr
         WHERE srno = #{value}
    </select>
    
    <select id="list" resultMap="srMap" parameterType="int">
        SELECT srno, mvno, mno, titl, time, phot, cont, spo
          FROM mv_sr
         WHERE mvno = #{mvno}
         ORDER BY time ASC
    </select>
    
    <select id="listCmt" resultMap="srCmtMap" parameterType="int">
        SELECT cmt.cmno, srno, mb.mno, phot, cont, cdt, mdt
              , mpno, mp_nm, lat, lng, nick, p_phot
          FROM mv_sr_cmt cmt LEFT JOIN mv_sr_map mp
               ON cmt.cmno = mp.cmno
               INNER JOIN mv_memb mb
               ON cmt.mno = mb.mno
         WHERE cmt.srno = #{value}
         ORDER BY cdt DESC
    </select>
    
    <select id="listTopSr" resultMap="srMap">
        SELECT srno, titl, time, phot, count(pstno)as cnt
          FROM mv_like ml,mv_sr ms 
         WHERE ml.pstno=ms.srno
           AND ml.type = 'sr'
         GROUP BY pstno 
        HAVING count(pstno)>0 
         ORDER by cnt DESC
         LIMIT 8
    </select>
    
    <update id="signOut" parameterType="int">
        UPDATE IGNORE mv_sr
        SET mno=21
        WHERE mno=#{mno}
    </update>

</mapper>